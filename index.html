<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¦ä¸­æ–‡ | Learn Chinese</title>
    
    <!-- PWA é…ç½® -->
    <link rel="manifest" href="src/data/manifest.json">
    <meta name="theme-color" content="#4CAF50">
    
    <!-- æ ¸å¿ƒè¯­è¨€å­—ä½“ (ä¸­æ–‡å’Œè‹±æ–‡) -->
    <style>
        /* ä½¿ç”¨AR PL UKaiå­—ä½“ */
        @font-face {
            font-family: 'AR PL UKai';
            font-style: normal;
            font-weight: 400;
            src: local('AR PL UKai'), local('ARPLUKaiCN');
            font-display: swap;
        }
    </style>
    
    <!-- CSS -->
    <link rel="stylesheet" href="src/css/style.css?v=3.16">
    
    <!-- ç¬¬ä¸‰æ–¹åº“ -->
    <!-- HanziWriteråº“ æœ¬åœ°å¼•ç”¨ -->
    <script src="src/js/lib/hanzi-writer.min.js"></script>
    
    <!-- html2canvasåº“ç”¨äºæˆªå±åˆ†äº«ï¼ˆåŠ¨æ€åŠ è½½ï¼Œä»…åœ¨éœ€è¦æ—¶åŠ è½½ï¼‰ -->
    
    <!-- å›¾æ ‡ -->
    <link rel="icon" type="image/png" href="./icon/icon-1024.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./icon/icon-1024.png">
    <link rel="apple-touch-icon" href="./icon/icon-1024.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./icon/icon-1024.png">
    
    <!-- iOS PWA æ”¯æŒ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å­¦ä¸­æ–‡">
    
    <!-- Android PWA æ”¯æŒ -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- æè¿°ä¿¡æ¯ -->
    <meta name="description" content="å­¦ä¹ ä¸­æ–‡çš„PWAåº”ç”¨,æ”¯æŒå¤šç§ä¸œå—äºšè¯­è¨€">
    <meta name="keywords" content="å­¦ä¸­æ–‡,ä¸­æ–‡å­¦ä¹ ,è¶Šå—è¯­,å°å°¼è¯­,ä¸œå—äºšè¯­è¨€,PWA">
</head>
<body>
    <!-- è¯­è¨€åˆ‡æ¢å™¨ -->
    <div class="language-switcher" id="language-switcher" style="display: none;">
        <span class="language-flag" id="current-language-flag">ğŸ‡»ğŸ‡³</span>
        <span class="language-code" id="current-language-code">VI</span>
    </div>

    <!-- è¯­è¨€é€‰æ‹©æ¨¡æ€æ¡†ï¼ˆé¦–æ¬¡è®¿é—®æ˜¾ç¤ºï¼‰ -->
    <div id="language-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <p class="subtitle">æ¯è¯­ (Native language)</p>
            </div>
            
            <div class="language-grid" id="language-grid">
                <!-- è¯­è¨€é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="modal-footer">
                <button id="confirm-language" class="primary-btn confirm-large" disabled>
                    ç¡®è®¤ / confirm
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div id="app" class="app" style="display: none;">
        <!-- ä¸‰å¤§å¡ç‰‡å®¹å™¨ï¼šå æ»¡ä¸»è¦é«˜åº¦ -->
        <div class="cards-container">
            <!-- ç¬¬1ä¸ªå¡ç‰‡ -->
            <div class="card-1 card">
                <button id="theme-toggle" class="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
                
                <div class="chinese-content">
                    <div class="pinyin" id="pinyin">hÇo hÇo xuÃ© xÃ­</div>
                    <div class="chinese" id="chinese">å¥½å¥½å­¦ä¹ </div>
                </div>
                
                <button class="favorite-btn" id="favorite-btn" aria-label="æ”¶è—">â˜†</button>
            </div>

            <!-- ç¬¬2ä¸ªå¡ç‰‡ -->
            <div class="card-2 card">
                <div class="translation" id="card-2-translation">Há»c táº­p chÄƒm chá»‰</div>
                <div class="english-translation" id="card-2-english">Study hard</div>
                <div class="explanation" id="card-2-explanation"></div>
            </div>

            <!-- ç¬¬3ä¸ªå¡ç‰‡ -->
            <div class="card-3 card">
                <!-- åŠŸèƒ½æŒ‰é’® -->
                <div class="func-buttons">
                    <button class="func-btn" id="stroke-btn" title="å†™å­—/ç¬”é¡º" aria-label="æ±‰å­—å†™å­—">âœï¸</button>
                    <button class="func-btn" id="favorites-btn" title="è¯æ±‡æœ¬" aria-label="æŸ¥çœ‹æ”¶è—">ğŸ“š</button>
                    <button class="func-btn" id="speech-btn" title="å‘éŸ³" aria-label="æ’­æ”¾å‘éŸ³"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
   <path d="M11 5L6 9H2v6h4l5 4V5z"/>
   <path d="M15.54 8.46a5 5 0 010 7.07"/>
   <path d="M19.07 4.93a10 10 0 010 14.14"/>
 </svg></button>
                    <button class="func-btn" id="search-btn" title="æœç´¢" aria-label="æœç´¢è¯æ¡">ğŸ”</button>
                    <button class="func-btn" id="share-btn" title="åˆ†äº«" aria-label="åˆ†äº«ç½‘ç«™">ğŸ’¬</button>
                </div>

                <!-- æ¡Œé¢ç«¯åº•éƒ¨å¯¼èˆªé“¾æ¥ -->
                <div class="desktop-bottom-links">
                    <span>About Us</span> | 
                    <span class="nav-link" data-href="https://www.shutterstock.com/zh/g/guangyaohlg?rid=331009" aria-label="Image Content - æ‰“å¼€æ–°çª—å£">Image Content</span> | 
                    <span class="nav-link" data-href="https://preply.com/en/?pref=MjQ4MDIwMTc=&id=1765940292.816984&ep=w2" aria-label="Real Tutor - æ‰“å¼€æ–°çª—å£">Real Tutor</span> | 
                    <span>Follow me on X</span>
                </div>
            </div>
        </div>        

        <!-- å›ºå®šåº•éƒ¨æ ï¼šå­—æ•°æŒ‰é’® + å¯¼èˆªæç¤º -->
        <div class="bottom-fixed-bar">
            <div class="length-selector">
                <button class="len-btn" data-length="1" aria-label="ä¸€å­—è¯">ä¸€</button>
                <button class="len-btn" data-length="2" aria-label="äºŒå­—è¯">äºŒ</button>
                <button class="len-btn" data-length="3" aria-label="ä¸‰å­—è¯">ä¸‰</button>
                <button class="len-btn" data-length="4" aria-label="å››å­—è¯">å››</button>
                <button class="len-btn" data-length="5" aria-label="äº”å­—è¯">äº”</button>
            </div>
        </div>
    </div>

    <!-- æœç´¢æ¨¡æ€æ¡† -->
    <div id="search-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ” æœç´¢ Search</h2>
            </div>
            <div class="modal-body">
                <input 
                    type="text" 
                    id="search-modal-input" 
                    placeholder="ä¸­æ–‡ / Pin Yin / English" 
                    autocomplete="off"
                    autofocus
                />
                <p class="hint">Pin Yin (hao hao xue xi) English (study hard) ä¸­æ–‡ï¼ˆå¥½å¥½å­¦ä¹ ï¼‰</p>
            </div>
            <div class="modal-actions">
                <button class="btn-primary" id="confirm-search">æœç´¢</button>
            </div>
        </div>
    </div>

    <!-- è¯æ±‡å¡ç‰‡ç½‘æ ¼å®¹å™¨ -->
    <div id="wordGrid" class="word-grid" style="display: none;">
        <!-- åŠ¨æ€ç”Ÿæˆçš„è¯æ±‡å¡ç‰‡å°†æ’å…¥è¿™é‡Œ -->
    </div>

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="loadingIndicator" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>æ­£åœ¨åŠ è½½...</p>
    </div>

    <!-- æ— ç»“æœæç¤º -->
    <div id="noResults" class="no-results" style="display: none;">
        <div class="no-results-content">
            <h3>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è¯æ¡</h3>
            <p>è¯·å°è¯•å…¶ä»–æœç´¢å…³é”®è¯</p>
        </div>
    </div>

    <!-- Toast æç¤º -->
    <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true" style="display:none;"></div>

    <!-- å¤šæ±‰å­—æç¤ºæ¨¡æ€æ¡† -->
    <div id="stroke-warning-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æç¤º</h2>
            </div>
            <div class="modal-body">
                <div id="stroke-warning-content" class="stroke-warning-content"></div>
            </div>
            <div class="modal-actions">
                <button id="close-stroke-warning" class="btn-primary">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- ç¬”é¡ºåŠ¨ç”»æ¨¡æ€æ¡† -->
    <div id="stroke-order-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="stroke-modal-title">æ±‰å­—ç¬”é¡º</h2>
            </div>
            <div class="modal-body">
                <div id="stroke-animation-container" class="stroke-animation-container"></div>
                <div class="stroke-controls">
                    <button id="play-stroke" class="btn-primary" title="æ’­æ”¾ç¬”é¡ºåŠ¨ç”»">â–¶</button>
                    <button id="practice-stroke" class="btn-secondary" title="ç»ƒä¹ ä¹¦å†™">ğŸ‘†</button>
                </div>
            </div>
            <div class="modal-actions">
                <button id="close-stroke-modal" class="btn-secondary">âœ•</button>
            </div>
        </div>
    </div>

    <!-- æ˜¾ç¤ºè®¡æ•°å™¨ -->
    <div id="displayCount" class="display-count" style="display: none;">
        <span id="count-number">0</span>
    </div>

    <!-- æ„è§åé¦ˆæ¨¡æ€æ¡† -->
    <div id="feedback-modal" class="modal" style="display: none;">
        <div class="modal-content feedback-modal-content">
            <div class="modal-header">
                <h2 id="feedback-title">ğŸ“ æ„è§åé¦ˆ</h2>
                <p class="subtitle" id="feedback-subtitle">æ‚¨çš„åé¦ˆå¯¹æˆ‘ä»¬éå¸¸é‡è¦</p>
            </div>
            
            <div class="modal-body">
                <!-- é—®é¢˜1ï¼šæœ€å–œæ¬¢çš„åŠŸèƒ½ -->
                <div class="feedback-section">
                    <label class="feedback-label" id="feedback-favorite-label">æ‚¨æœ€å–œæ¬¢çš„åŠŸèƒ½æ˜¯ä»€ä¹ˆï¼Ÿ</label>
                    <div class="feedback-options">
                        <label class="feedback-option">
                            <input type="radio" name="favorite-feature" value="stroke-order">
                            <span id="feedback-opt-stroke">æ±‰å­—ç¬”é¡º</span>
                        </label>
                        <label class="feedback-option">
                            <input type="radio" name="favorite-feature" value="speech">
                            <span id="feedback-opt-speech">è¯­éŸ³å‘éŸ³</span>
                        </label>
                        <label class="feedback-option">
                            <input type="radio" name="favorite-feature" value="search">
                            <span id="feedback-opt-search">æœç´¢åŠŸèƒ½</span>
                        </label>
                        <label class="feedback-option">
                            <input type="radio" name="favorite-feature" value="favorites">
                            <span id="feedback-opt-favorites">æ”¶è—è¯æ±‡</span>
                        </label>
                    </div>
                </div>
                
                <!-- é—®é¢˜2ï¼šæ˜¯å¦æ„¿æ„ä»˜è´¹ -->
                <div class="feedback-section">
                    <label class="feedback-label" id="feedback-willingness-label">æ‚¨æ„¿æ„ä¸ºé«˜çº§åŠŸèƒ½ä»˜è´¹å—ï¼Ÿ</label>
                    <div class="feedback-options">
                        <label class="feedback-option">
                            <input type="radio" name="payment-willingness" value="yes">
                            <span id="feedback-opt-yes">æ„¿æ„</span>
                        </label>
                        <label class="feedback-option">
                            <input type="radio" name="payment-willingness" value="maybe">
                            <span id="feedback-opt-maybe">å¯ä»¥è€ƒè™‘</span>
                        </label>
                        <label class="feedback-option">
                            <input type="radio" name="payment-willingness" value="no">
                            <span id="feedback-opt-no">ä¸æ„¿æ„</span>
                        </label>
                    </div>
                </div>
                
                <!-- é—®é¢˜3ï¼šæœŸå¾…çš„æ–°åŠŸèƒ½ -->
                <div class="feedback-section">
                    <label class="feedback-label" id="feedback-features-label">æ‚¨å¸Œæœ›æˆ‘ä»¬æ·»åŠ ä»€ä¹ˆæ–°åŠŸèƒ½ï¼Ÿ</label>
                    <div class="feedback-options">
                        <label class="feedback-option">
                            <input type="checkbox" name="new-features" value="ai-tutor">
                            <span id="feedback-feat-ai">AIå¯¼å¸ˆè¾…å¯¼</span>
                        </label>
                        <label class="feedback-option">
                            <input type="checkbox" name="new-features" value="live-class">
                            <span id="feedback-feat-live">çœŸäººç›´æ’­è¯¾</span>
                        </label>
                        <label class="feedback-option">
                            <input type="checkbox" name="new-features" value="ocr-scan">
                            <span id="feedback-feat-ocr">æ‹ç…§OCRè¯†å­—</span>
                        </label>
                        <label class="feedback-option">
                            <input type="checkbox" name="new-features" value="more-vocab">
                            <span id="feedback-feat-vocab">æ›´å¤šè¯æ±‡å†…å®¹</span>
                        </label>
                    </div>
                </div>
                
                <!-- é—®é¢˜4ï¼šå…¶ä»–å»ºè®® -->
                <div class="feedback-section">
                    <label class="feedback-label" id="feedback-suggestion-label">å…¶ä»–å»ºè®®ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea id="feedback-suggestion" class="feedback-textarea" placeholder="è¯·è¾“å…¥æ‚¨çš„å»ºè®®..."></textarea>
                </div>
                
                <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
                <div class="feedback-progress">
                    <span id="feedback-progress-text">å·²æ”¶é›† 0/10 æ¡åé¦ˆ</span>
                </div>
                
                <!-- å¯¼å‡ºæŒ‰é’® -->
                <div class="feedback-export-section">
                    <button id="export-feedback" class="btn-secondary feedback-export-btn">
                        ğŸ“¥ <span id="feedback-btn-export">å¯¼å‡ºåé¦ˆæ–‡ä»¶</span>
                    </button>
                    <p class="feedback-export-hint" id="feedback-export-hint">ä¸‹è½½åå¯å‘é€åˆ° X ç§ä¿¡ç»™æˆ‘</p>
                </div>
            </div>
            
            <div class="modal-actions feedback-modal-actions">
                <button id="skip-feedback" class="btn-secondary">
                    <span id="feedback-btn-skip">è·³è¿‡</span>
                </button>
                <button id="submit-feedback" class="btn-primary">
                    <span id="feedback-btn-submit">æäº¤</span>
                </button>
            </div>
        </div>
    </div>


    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>

    <!-- Google Analytics 4 ç»Ÿè®¡ä»£ç å’Œæ¨èç è¿½è¸ª -->
    <script>
        // ========================================
        // è¯·å°† G-XXXXXXXXXX æ›¿æ¢ä¸ºä½ çš„ GA4 æµ‹é‡ID
        // è·å–æ–¹å¼ï¼šhttps://analytics.google.com/
        // ========================================
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XXXXXXXXXX');

        // ========================================
        // æ¨èç è¿½è¸ªåŠŸèƒ½
        // é¡µé¢åŠ è½½æ—¶è§£æ URL ä¸­çš„ ref å‚æ•°å¹¶æ¨é€åˆ° GA4
        // ========================================
        function initReferralTracking() {
            // ä» URL ä¸­è·å–æ¨èç 
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');

            if (refCode) {
                console.log('æ£€æµ‹åˆ°æ¨èç :', refCode);

                // å°†æ¨èç ä¿å­˜åˆ° localStorage
                localStorage.setItem('referredBy', refCode);

                // å¦‚æœæ˜¯é¦–æ¬¡è®¿é—®ï¼Œå‘é€åˆ° GA4
                const firstVisit = localStorage.getItem('firstVisitTime');
                if (!firstVisit) {
                    localStorage.setItem('firstVisitTime', Date.now().toString());

                    // å‘é€åˆ° GA4 ä½œä¸ºæ–°ç”¨æˆ·äº‹ä»¶
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'referral_signup', {
                            'referral_code': refCode,
                            'referral_source': 'share_link'
                        });

                        // åŒæ—¶è®¾ç½®ç”¨æˆ·å±æ€§ï¼Œç”¨äºåœ¨ GA4 åå°æŒ‰æ¨èç ç­›é€‰
                        gtag('set', 'user_properties', {
                            referred_by: refCode
                        });
                    }

                    console.log('æ–°ç”¨æˆ·æ¨èè®°å½•å·²å‘é€åˆ° GA4ï¼Œæ¨èç :', refCode);
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ¨èè¿½è¸ª
        initReferralTracking();
    </script>

    <!-- è„šæœ¬ -->
    <script src="src/js/language.js"></script>
    <script src="src/js/font-loader.js"></script>
    <script src="src/js/theme.js"></script>

    <script type="module" src="src/js/app.js"></script>
    <script src="src/js/sw-register.js"></script>

    <script>
        // è·å–è®¾å¤‡æç¤ºçš„è¯­è¨€æ–‡æœ¬
        function getDeviceLanguageText() {
            const userLanguage = localStorage.getItem('userLanguage') || 'default';
            return deviceLanguageTexts[userLanguage] || deviceLanguageTexts['default'];
        }
        
        // è®¾å¤‡æ£€æµ‹é€»è¾‘ï¼ˆç»Ÿä¸€ä½¿ç”¨è¿™ä¸ªå‡½æ•°ï¼‰
        function isDesktopDevice() {
            // æ£€æŸ¥æ˜¯å¦ä¸ºæ¡Œé¢è®¾å¤‡çš„å¤šç§æ–¹æ³•
            const userAgent = navigator.userAgent.toLowerCase();
            const isMobile = /android|webos|iphone|ipad|ipod|blackberry|windows phone|mobile/.test(userAgent);
            const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            const screenWidth = window.innerWidth;
            
            // å¦‚æœä¸æ˜¯ç§»åŠ¨è®¾å¤‡ï¼Œä¸”ä¸æ”¯æŒè§¦æ‘¸ï¼Œä¸”å±å¹•å®½åº¦è¶³å¤Ÿå¤§ï¼Œåˆ™åˆ¤æ–­ä¸ºæ¡Œé¢è®¾å¤‡
            return !isMobile && !hasTouch && screenWidth > 768;
        }
        
        // æ˜¾ç¤ºè®¾å¤‡æç¤ºæ¨¡æ€æ¡†
        function showDeviceModal() {
            const deviceModal = document.getElementById('device-modal');
            if (deviceModal) {
                deviceModal.style.display = 'flex';
                
                // æ ¹æ®ç”¨æˆ·è¯­è¨€æ›´æ–°æ¨¡æ€æ¡†å†…å®¹
                const texts = getDeviceLanguageText();
                
                const titleElement = document.getElementById('device-modal-title');
                const messageElement = document.getElementById('device-message-native');
                const dismissButtonElement = document.getElementById('dismiss-button-text');
                
                if (titleElement) titleElement.textContent = texts.title;
                if (messageElement) messageElement.textContent = texts.message;
                if (dismissButtonElement) dismissButtonElement.textContent = texts.dismiss;
            }
        }
        
        // å…³é—­è®¾å¤‡æç¤ºæ¨¡æ€æ¡†
        function dismissDeviceModal() {
            const deviceModal = document.getElementById('device-modal');
            if (deviceModal) {
                deviceModal.style.display = 'none';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æµ‹è®¾å¤‡ç±»å‹
        document.addEventListener('DOMContentLoaded', function() {
            // ä¸ºå…³é—­æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const dismissBtn = document.getElementById('dismiss-device-notice');
            if (dismissBtn) {
                dismissBtn.addEventListener('click', dismissDeviceModal);
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰é€‰æ‹©çš„è¯­è¨€
            const userLanguage = localStorage.getItem('userLanguage');
            
            if (userLanguage) {
                // å¦‚æœå·²ç»é€‰æ‹©äº†è¯­è¨€ï¼Œç›´æ¥æ˜¾ç¤ºè®¾å¤‡æç¤º
                if (isDesktopDevice()) {
                    showDeviceModal();
                }
            } else {
                // å¦‚æœè¿˜æ²¡æœ‰é€‰æ‹©è¯­è¨€ï¼Œç›‘å¬è¯­è¨€é€‰æ‹©äº‹ä»¶
                window.addEventListener('languageSelected', function() {
                    if (isDesktopDevice()) {
                        showDeviceModal();
                    }
                });
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('å­¦ä¸­æ–‡åº”ç”¨åˆå§‹åŒ–...');
            
            if (typeof languageManager !== 'undefined') {
                languageManager.init().catch(err => {
                    console.error('âŒ è¯­è¨€ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', err);
                });
            }
        });
    </script>

<script>
/**
 * Iframe å…ƒç´ é«˜äº®æ³¨å…¥è„šæœ¬
 * éœ€è¦åœ¨ç›®æ ‡ç½‘ç«™ä¸­å¼•å…¥æ­¤è„šæœ¬æ¥æ”¯æŒè·¨åŸŸ iframe é«˜äº®åŠŸèƒ½
 *
 * ä½¿ç”¨æ–¹æ³•ï¼š
 * 1. å°†æ­¤è„šæœ¬æ·»åŠ åˆ°ç›®æ ‡ç½‘ç«™çš„ HTML ä¸­
 * 2. æˆ–é€šè¿‡æµè§ˆå™¨æ‰©å±•ã€ç”¨æˆ·è„šæœ¬ç­‰æ–¹å¼æ³¨å…¥
 */

(function () {
  "use strict";

  // æ£€æŸ¥æ˜¯å¦åœ¨ iframe ä¸­
  if (window.self === window.top) {
    return; // ä¸åœ¨ iframe ä¸­ï¼Œä¸æ‰§è¡Œ
  }

  // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡
  if (window.__iframeHighlightInitialized) {
    return;
  }
  window.__iframeHighlightInitialized = true;
  console.log("Iframe é«˜äº®è„šæœ¬å·²åŠ è½½");

  // åˆ›å»ºé«˜äº®è¦†ç›–å±‚
  var overlay = document.createElement("div");
  overlay.id = "iframe-highlight-overlay";
  overlay.style.cssText = "\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100vw;\n    height: 100vh;\n    pointer-events: none;\n    z-index: 999999;\n    overflow: hidden;\n  ";

  // åˆ›å»ºæ‚¬åœé«˜äº®æ¡†ï¼ˆè™šçº¿è¾¹æ¡†ï¼‰
  var highlightBox = document.createElement("div");
  highlightBox.id = "iframe-highlight-box";
  highlightBox.style.cssText = "\n    position: absolute;\n    border: 2px dashed #007AFF;\n    background: rgba(0, 122, 255, 0.08);\n    pointer-events: none;\n    display: none;\n    transition: all 0.1s ease;\n    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.8);\n    border-radius: 2px;\n  ";

  // åˆ›å»ºé€‰ä¸­èŠ‚ç‚¹çš„å¸¸é©»é«˜äº®æ¡†ï¼ˆå®çº¿è¾¹æ¡†ï¼‰
  var selectedBox = document.createElement("div");
  selectedBox.id = "iframe-selected-box";
  selectedBox.style.cssText = "\n    position: absolute;\n    border: 2px solid #007AFF;\n    pointer-events: none;\n    display: none;\n    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.9), 0 0 8px rgba(255, 107, 53, 0.4);\n    border-radius: 2px;\n    z-index: 1000000;\n  ";

  // åˆ›å»ºæ‚¬åœæ ‡ç­¾æ˜¾ç¤º
  var tagLabel = document.createElement("div");
  tagLabel.id = "iframe-tag-label";
  tagLabel.style.cssText = "\n    position: absolute;\n    background: #007AFF;\n    color: white;\n    padding: 2px 6px;\n    font-size: 11px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n    border-radius: 2px;\n    pointer-events: none;\n    display: none;\n    white-space: nowrap;\n    z-index: 1000001;\n    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);\n    font-weight: 500;\n  ";

  // åˆ›å»ºé€‰ä¸­èŠ‚ç‚¹æ ‡ç­¾
  var selectedLabel = document.createElement("div");
  selectedLabel.id = "iframe-selected-label";
  selectedLabel.style.cssText = "\n    position: absolute;\n    background: #007AFF;\n    color: white;\n    padding: 3px 8px;\n    font-size: 11px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n    border-radius: 3px;\n    pointer-events: none;\n    display: none;\n    white-space: nowrap;\n    z-index: 1000002;\n    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);\n    font-weight: 600;\n  ";
  overlay.appendChild(highlightBox);
  overlay.appendChild(selectedBox);
  overlay.appendChild(tagLabel);
  overlay.appendChild(selectedLabel);
  document.body.appendChild(overlay);

  // å­˜å‚¨å½“å‰é€‰ä¸­çš„å…ƒç´ 
  var selectedElement = null;
  var highlightEnabled = false;

  // æ›´æ–°é€‰ä¸­å…ƒç´ çš„é«˜äº®æ˜¾ç¤º
  function updateSelectedHighlight(element) {
    console.log("updateSelectedHighlight called with:", element);
    if (!element) {
      selectedBox.style.display = "none";
      selectedLabel.style.display = "none";
      selectedElement = null;
      console.log("Cleared selected highlight");
      return;
    }
    selectedElement = element;
    var rect = element.getBoundingClientRect();
    console.log("Selected element rect:", rect);

    // æ›´æ–°é€‰ä¸­é«˜äº®æ¡†ä½ç½®
    selectedBox.style.display = "block";
    selectedBox.style.left = "".concat(rect.left - 2, "px");
    selectedBox.style.top = "".concat(rect.top - 2, "px");
    selectedBox.style.width = "".concat(rect.width + 4, "px");
    selectedBox.style.height = "".concat(rect.height + 4, "px");

    // æ›´æ–°é€‰ä¸­æ ‡ç­¾ä½ç½®å’Œå†…å®¹
    selectedLabel.style.display = "block";
    selectedLabel.textContent = "\u2713 <".concat(element.tagName.toLowerCase(), ">");

    // è®¡ç®—æ ‡ç­¾ä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºè§†çª—
    var labelTop = rect.top - 28;
    var labelLeft = rect.left;

    // å¦‚æœæ ‡ç­¾ä¼šè¶…å‡ºé¡¶éƒ¨ï¼Œæ˜¾ç¤ºåœ¨å…ƒç´ ä¸‹æ–¹
    if (labelTop < 5) {
      labelTop = rect.bottom + 5;
    }

    // å¦‚æœæ ‡ç­¾ä¼šè¶…å‡ºå³ä¾§ï¼Œå‘å·¦è°ƒæ•´
    var labelWidth = selectedLabel.offsetWidth || 100; // é¢„ä¼°å®½åº¦
    if (labelLeft + labelWidth > window.innerWidth - 10) {
      labelLeft = window.innerWidth - labelWidth - 10;
    }
    selectedLabel.style.left = "".concat(Math.max(5, labelLeft), "px");
    selectedLabel.style.top = "".concat(labelTop, "px");
    console.log("Selected highlight positioned at:", {
      left: selectedBox.style.left,
      top: selectedBox.style.top,
      width: selectedBox.style.width,
      height: selectedBox.style.height
    });
  }
  function getElementSelector(element) {
    if (!(element instanceof Element)) throw new Error('Argument must be a DOM element');
    var segments = [];
    var current = element;
    while (current !== document.documentElement) {
      var selector = '';
      // ä¼˜å…ˆæ£€æŸ¥å”¯ä¸€ID
      if (current.id && document.querySelectorAll("#".concat(current.id)).length === 1) {
        segments.unshift("#".concat(current.id));
        break; // IDå”¯ä¸€ï¼Œæ— éœ€ç»§ç»­å‘ä¸Š
      }

      // ç”Ÿæˆç±»åé€‰æ‹©å™¨ï¼ˆå–ç¬¬ä¸€ä¸ªæœ‰æ•ˆç±»åï¼‰
      var classes = Array.from(current.classList).filter(function (c) {
        return !c.startsWith('js-');
      });
      var className = classes.length > 0 ? ".".concat(classes[0]) : '';

      // ç”Ÿæˆä½ç½®ç´¢å¼•ï¼ˆnth-childï¼‰
      var tag = current.tagName.toLowerCase();
      if (!className) {
        var siblings = Array.from(current.parentNode.children);
        var index = siblings.findIndex(function (el) {
          return el === current;
        }) + 1;
        selector = "".concat(tag, ":nth-child(").concat(index, ")");
      } else {
        selector = className;
      }
      segments.unshift(selector);
      current = current.parentElement;
    }

    // å¤„ç†æ ¹å…ƒç´ 
    if (current === document.documentElement) {
      segments.unshift('html');
    }
    return segments.join(' > ');
  }

  // è·å–å…ƒç´ æ–‡æœ¬å†…å®¹
  function getElementText(element) {
    var _element$textContent;
    if (element.tagName === "INPUT") {
      return element.value || element.placeholder || "";
    }
    if (element.tagName === "TEXTAREA") {
      return element.value || element.placeholder || "";
    }
    var text = ((_element$textContent = element.textContent) === null || _element$textContent === void 0 ? void 0 : _element$textContent.trim()) || "";
    return text.length > 50 ? text.substring(0, 50) + "..." : text;
  }

  // è·å–å…ƒç´ å±æ€§ä¿¡æ¯
  function getElementAttributes(element) {
    var attrs = {};
    for (var i = 0; i < element.attributes.length; i++) {
      var attr = element.attributes[i];
      attrs[attr.name] = attr.value;
    }
    return attrs;
  }

  // é¼ æ ‡æ‚¬åœäº‹ä»¶å¤„ç†
  function handleMouseOver(e) {
    if (!highlightEnabled) return;
    var target = e.target;
    if (!target || target === overlay || target === highlightBox || target === tagLabel || target === selectedBox || target === selectedLabel) {
      return;
    }

    // é¿å…é«˜äº® html å’Œ body å…ƒç´ 
    if (target === document.documentElement || target === document.body) {
      return;
    }

    // å¦‚æœæ˜¯å·²é€‰ä¸­çš„å…ƒç´ ï¼Œä¸æ˜¾ç¤ºæ‚¬åœé«˜äº®
    if (target === selectedElement) {
      highlightBox.style.display = "none";
      tagLabel.style.display = "none";
      return;
    }
    var rect = target.getBoundingClientRect();
    var selector = getElementSelector(target);
    var text = getElementText(target);
    var attributes = getElementAttributes(target);

    // æ›´æ–°æ‚¬åœé«˜äº®æ¡†ä½ç½®
    highlightBox.style.display = "block";
    highlightBox.style.left = "".concat(rect.left - 2, "px");
    highlightBox.style.top = "".concat(rect.top - 2, "px");
    highlightBox.style.width = "".concat(rect.width + 4, "px");
    highlightBox.style.height = "".concat(rect.height + 4, "px");

    // æ›´æ–°æ ‡ç­¾ä½ç½®å’Œå†…å®¹
    tagLabel.style.display = "block";
    tagLabel.textContent = "<".concat(target.tagName.toLowerCase(), ">");

    // è®¡ç®—æ ‡ç­¾ä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºè§†çª—
    var labelTop = rect.top - 22;
    var labelLeft = rect.left;

    // å¦‚æœæ ‡ç­¾ä¼šè¶…å‡ºé¡¶éƒ¨ï¼Œæ˜¾ç¤ºåœ¨å…ƒç´ ä¸‹æ–¹
    if (labelTop < 0) {
      labelTop = rect.bottom + 5;
    }

    // å¦‚æœæ ‡ç­¾ä¼šè¶…å‡ºå³ä¾§ï¼Œå‘å·¦è°ƒæ•´
    if (labelLeft + tagLabel.offsetWidth > window.innerWidth) {
      labelLeft = window.innerWidth - tagLabel.offsetWidth - 5;
    }
    tagLabel.style.left = "".concat(Math.max(0, labelLeft), "px");
    tagLabel.style.top = "".concat(labelTop, "px");

    // å‘é€æ¶ˆæ¯åˆ°çˆ¶çª—å£
    var elementInfo = {
      tagName: target.tagName.toLowerCase(),
      rect: {
        left: rect.left,
        top: rect.top,
        right: rect.right,
        bottom: rect.bottom,
        width: rect.width,
        height: rect.height,
        x: rect.x,
        y: rect.y
      },
      selector: selector,
      text: text,
      attributes: attributes,
      url: window.location.href,
      path: window.location.pathname,
      timestamp: Date.now()
    };
    try {
      window.parent.postMessage({
        type: "iframe-element-hover",
        data: elementInfo,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("æ— æ³•å‘é€æ¶ˆæ¯åˆ°çˆ¶çª—å£:", error);
    }
  }

  // é¼ æ ‡ç¦»å¼€äº‹ä»¶å¤„ç†
  function handleMouseOut(e) {
    if (!highlightEnabled) return;
    var relatedTarget = e.relatedTarget;

    // å¦‚æœé¼ æ ‡ç§»åŠ¨åˆ°é«˜äº®ç›¸å…³å…ƒç´ ä¸Šï¼Œä¸éšè—é«˜äº®
    if (relatedTarget && (relatedTarget === highlightBox || relatedTarget === tagLabel || relatedTarget === overlay || relatedTarget === selectedBox || relatedTarget === selectedLabel)) {
      return;
    }
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    try {
      window.parent.postMessage({
        type: "iframe-element-hover",
        data: null,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("æ— æ³•å‘é€æ¶ˆæ¯åˆ°çˆ¶çª—å£:", error);
    }
  }

  // ç‚¹å‡»äº‹ä»¶å¤„ç†
  function handleClick(e) {
    var target = e.target;
    if (!target || target === overlay || target === highlightBox || target === tagLabel || target === selectedBox || target === selectedLabel) {
      return;
    }

    // é¿å…å¤„ç† html å’Œ body å…ƒç´ 
    if (target === document.documentElement || target === document.body) {
      return;
    }

    // æ£€æŸ¥æ˜¯å¦æ˜¯äº¤äº’å…ƒç´ ï¼Œè¿™äº›å…ƒç´ éœ€è¦ä¿ç•™é»˜è®¤è¡Œä¸º
    var isInteractiveElement = ['input', 'textarea', 'select', 'button', 'a'].includes(target.tagName.toLowerCase());

    // å¦‚æœé«˜äº®åŠŸèƒ½å¯ç”¨ï¼Œå¯¹äºéäº¤äº’å…ƒç´ é˜»æ­¢é»˜è®¤è¡Œä¸ºå’Œäº‹ä»¶ä¼ æ’­
    if (highlightEnabled) {
      e.preventDefault();
      e.stopPropagation();
    }
    var rect = target.getBoundingClientRect();
    var selector = getElementSelector(target);
    var text = getElementText(target);
    var attributes = getElementAttributes(target);
    console.log("Element clicked:", {
      tagName: target.tagName,
      selector: selector,
      rect: rect
    });

    // ç«‹å³æ›´æ–°é€‰ä¸­é«˜äº®
    updateSelectedHighlight(target);

    // éšè—æ‚¬åœé«˜äº®ï¼Œå› ä¸ºç°åœ¨æ˜¯é€‰ä¸­çŠ¶æ€
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    var elementInfo = {
      tagName: target.tagName.toLowerCase(),
      rect: {
        left: rect.left,
        top: rect.top,
        right: rect.right,
        bottom: rect.bottom,
        width: rect.width,
        height: rect.height,
        x: rect.x,
        y: rect.y
      },
      selector: selector,
      text: text,
      attributes: attributes,
      url: window.location.href,
      path: window.location.pathname,
      timestamp: Date.now()
    };
    try {
      window.parent.postMessage({
        type: "iframe-element-click",
        data: elementInfo,
        source: "iframe-highlight-injector"
      }, "*");
    } catch (error) {
      console.warn("æ— æ³•å‘é€æ¶ˆæ¯åˆ°çˆ¶çª—å£:", error);
    }
  }

  // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ¶ˆæ¯
  function handleParentMessage(event) {
    console.log("Received message from parent:", event.data);
    if (event.data.type === "iframe-highlight-toggle") {
      var enabled = event.data.enabled;
      console.log("Highlight toggle:", enabled);
      if (enabled) {
        enableHighlight();
      } else {
        disableHighlight();
      }
    } else if (event.data.type === "enable-iframe-highlight") {
      console.log("Enable iframe highlight");
      enableHighlight();
    } else if (event.data.type === "disable-iframe-highlight") {
      console.log("Disable iframe highlight");
      disableHighlight();
    } else if (event.data.type === "toggle-iframe-highlight") {
      var _enabled = event.data.enabled !== undefined ? event.data.enabled : !highlightEnabled;
      console.log("Toggle iframe highlight to:", _enabled);
      if (_enabled) {
        enableHighlight();
      } else {
        disableHighlight();
      }
    } else if (event.data.type === "update-selected-element") {
      var selector = event.data.selector;
      console.log("Update selected element with selector:", selector);
      if (selector) {
        try {
          var element = document.querySelector(selector);
          console.log("Found element by selector:", element);
          updateSelectedHighlight(element);
        } catch (error) {
          console.warn("Failed to select element:", error);
          updateSelectedHighlight(null);
        }
      } else {
        updateSelectedHighlight(null);
      }
    } else if (event.data.type === "clear-selected-element") {
      console.log("Clear selected element");
      updateSelectedHighlight(null);
    }
  }

  // å¯ç”¨é«˜äº®åŠŸèƒ½
  function enableHighlight() {
    console.log("Enabling highlight");
    document.addEventListener("mouseover", handleMouseOver, true);
    document.addEventListener("mouseout", handleMouseOut, true);
    document.addEventListener("click", handleClick, true);
    highlightEnabled = true;
    overlay.style.display = "block";
  }

  // ç¦ç”¨é«˜äº®åŠŸèƒ½
  function disableHighlight() {
    console.log("Disabling highlight");
    highlightEnabled = false;
    // ä¿æŒäº‹ä»¶ç›‘å¬å™¨ï¼Œä½†é€šè¿‡ highlightEnabled å˜é‡æ§åˆ¶è¡Œä¸º
    // è¿™æ ·å¯ä»¥ä¿ç•™é€‰ä¸­çŠ¶æ€çš„æ˜¾ç¤º
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    // ä¸éšè— selectedBox å’Œ selectedLabelï¼Œä¿ç•™é€‰ä¸­çŠ¶æ€
  }

  // å®Œå…¨ç¦ç”¨é«˜äº®åŠŸèƒ½ï¼ˆç§»é™¤æ‰€æœ‰ç›‘å¬å™¨ï¼‰
  function fullyDisableHighlight() {
    console.log("Fully disabling highlight");
    highlightEnabled = false;
    document.removeEventListener("mouseover", handleMouseOver, true);
    document.removeEventListener("mouseout", handleMouseOut, true);
    document.removeEventListener("click", handleClick, true);
    overlay.style.display = "none";
    highlightBox.style.display = "none";
    tagLabel.style.display = "none";
    selectedBox.style.display = "none";
    selectedLabel.style.display = "none";
  }

  // æ·»åŠ äº‹ä»¶ç›‘å¬
  enableHighlight();
  window.addEventListener("message", handleParentMessage);

  // æš´éœ²å…¨å±€å‡½æ•°ä¾›å¤–éƒ¨è°ƒç”¨
  window.__iframeHighlightControl = {
    enable: enableHighlight,
    disable: disableHighlight,
    fullyDisable: fullyDisableHighlight,
    isEnabled: function isEnabled() {
      return highlightEnabled;
    },
    getSelectedElement: function getSelectedElement() {
      return selectedElement;
    },
    updateSelected: updateSelectedHighlight,
    // é€šè¿‡æ¶ˆæ¯å‘é€å¼€å…³æ§åˆ¶
    sendToggleMessage: function sendToggleMessage(enabled) {
      window.parent.postMessage({
        type: 'iframe-highlight-status',
        enabled: enabled || highlightEnabled,
        source: 'iframe-highlight-injector'
      }, '*');
    }
  };

  // é€šçŸ¥çˆ¶çª—å£è„šæœ¬å·²åŠ è½½
  try {
    window.parent.postMessage({
      type: "iframe-highlight-ready",
      data: {
        url: window.location.href,
        userAgent: navigator.userAgent,
        timestamp: Date.now()
      },
      source: "iframe-highlight-injector"
    }, "*");
  } catch (error) {
    console.warn("æ— æ³•å‘é€å°±ç»ªæ¶ˆæ¯åˆ°çˆ¶çª—å£:", error);
  }

  // æ¸…ç†å‡½æ•°
  window.__iframeHighlightCleanup = function () {
    fullyDisableHighlight();
    window.removeEventListener("message", handleParentMessage);
    if (overlay.parentElement) {
      overlay.parentElement.removeChild(overlay);
    }
    delete window.__iframeHighlightInitialized;
    delete window.__iframeHighlightCleanup;
  };
})();

</script>
</body>
</html>
